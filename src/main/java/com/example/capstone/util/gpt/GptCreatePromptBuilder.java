package com.example.capstone.util.gpt;

import com.example.capstone.plan.entity.City;
import com.example.capstone.user.entity.MBTI;
import com.example.capstone.plan.entity.PeopleGroup;
import com.example.capstone.matching.entity.TravelStyle;
import com.example.capstone.plan.dto.request.ScheduleCreateReqDto;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;

import java.time.format.DateTimeFormatter;

@Component
@RequiredArgsConstructor
public class GptCreatePromptBuilder {

    public String build(ScheduleCreateReqDto request) {
        StringBuilder sb = new StringBuilder();
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy년 MM월 dd일");
        String formattedStart = request.getStartDate().format(formatter);
        String formattedEnd = request.getEndDate().format(formatter);

        boolean isDomestic = request.getDestination() == City.NONE;
        String destinationText = isDomestic ? "국내" : request.getDestination().getDisplayName();


        sb.append(String.format("""
다음 요구사항에 따라 여행 일정을 생성하라.

[여행 정보]
- 기간: %s ~ %s
- 목적지: %s
""", formattedStart, formattedEnd, destinationText));

        if (isDomestic) {
            sb.append("""
- 목적지 '국내'인 경우: 계절/MBTI/여행성향/예산/인원을 고려하여 **대한민국의 실제 시(市) 단위 도시 1곳만** 스스로 선택하여 전체 일정을 구성한다.
""");
        }

        if (request.getMbti() != MBTI.NONE) sb.append("- MBTI: ").append(request.getMbti()).append("\n");
        if (request.getTravelStyle() != TravelStyle.NONE) sb.append("- 여행 성향: ").append(request.getTravelStyle()).append("\n");
        if (request.getPeopleGroup() != PeopleGroup.NONE) sb.append("- 여행 인원: ").append(request.getPeopleGroup()).append("명\n");
        if (request.getBudget() != null) sb.append("- 예산: ").append(request.getBudget()).append("원\n");


        sb.append("""
        
너는 한국 국내 여행 일정을 생성하는 도우미야.
입력된 기간과 목적지 범위(시/군/구 경계 내부)에서만 장소를 선정해.

[성향 반영 가이드라인]

(1) MBTI별 여행 성향
- ISFP: 조용하고 감성적인 여행을 선호하므로 자연경관, 감성카페, 예술 관련 명소 중심으로 구성하라.
- INFP: 문화·예술적 감수성이 높은 편이므로 문학관, 미술관, 서점, 평온한 카페를 포함하라.
- ISTP: 체험형 활동(등산, 자전거, 트레킹 등)과 휴식을 적절히 섞어 구성하라.
- ESTP: 즉흥적이고 활동적 성향이므로 액티비티, 야시장, 맛집 탐방 중심으로 구성하라.
- ENFP: 활발하고 사교적이므로 SNS 인기 명소, 체험형 장소, 화려한 조명이 있는 밤거리 등을 포함하라.
- ENFJ: 사람과 교류하기 좋은 카페거리, 전통시장, 지역 축제 등을 포함하라.
- INTJ: 계획적이며 의미 중심이므로 역사 유적지, 과학관, 건축물 위주의 일정으로 구성하라.
- ENTJ: 효율적 이동, 대표 명소 위주로 구성하며, 유명 맛집과 고급 숙소를 포함하라.
- 기타 MBTI는 성향에 맞는 활동 수준과 감성 중심지를 고려하여 자연스럽게 구성하라.

(2) 여행 성향(TravelStyle)
- NONE: 여행 성향을 선택하지 않은 경우, 기본적인 일정으로 구성하라.
- HEALING: 여유롭고 조용한 일정, 이동거리 짧게. 카페·전망 포인트·호수·공원 위주로 구성하라.
- ACTIVITY: 활동적인 일정, 트레킹·체험·시장·전망대 등 외부 활동을 포함하라.
- CULTURE: 문화예술 중심, 미술관·전시관·유적지·문화센터를 포함하라.
- FOOD: 지역 대표 음식과 맛집을 다양하게 포함하되, 같은 음식종류는 중복 금지.
- CITY: 도심 기반 일정, 쇼핑·야경·트렌디한 명소를 포함하라.
- NATURE: 산·호수·강·숲 등 자연 명소 중심으로 구성하되, 숙소도 자연 친화적이어야 한다.

(3) 인원 수(PeopleGroup)
- NONE: 인원 수를 선택하지 않은 경우, 기본적인 일정으로 구성하라.
- SOLO: 개인 여행자 중심으로 조용한 장소와 1인 식사 가능한 식당을 포함하라.
- DUO: 친구 또는 커플 여행자 중심, 포토존·SNS명소·감성 숙소를 포함하라.
- GROUP: 가족·단체 여행 중심으로 이동 동선이 짧고 주차가 편리한 장소를 포함하라.

(4) 계절 반영(Season)
- 봄(3월 1일 ~ 5월 31일): 꽃구경, 벚꽃길, 산책로, 자연공원 위주로 구성.
- 여름(6월 1일 ~ 8월 31일): 계곡, 해수욕장, 수영장, 야간 명소 포함.
- 가을(9월 1일 ~ 11월 30일): 단풍, 산책길, 문화축제, 전시회 중심.
- 겨울(12월 1일 ~ 2월 28일): 실내 명소, 온천, 전통시장, 따뜻한 음식 위주로 구성.

[핵심 규칙]
  1) 날짜별로 정확히 7개 항목만 생성하고, 순서를 엄격히 지킨다:
     [아침(식사) → 관광지 → 점심(식사) → 관광지 → 저녁(식사) → 관광지 → 숙소]
     - 누락/추가/순서변경 금지.
  2) 날짜는 요청의 시작일~종료일을 모두 포함하여 "date"에 YYYY-MM-DD 로 표기한다.
  3) 전체 일정에서 장소 **중복 금지**(동일/유사 명칭 포함).

  [명칭 규칙]
  [관광지(실존·공식 명칭만) 규칙]
     - 반드시 **실제로 존재**하고 **공식적으로 사용되는 정식 표기 그대로**만 사용한다.
     - 정식 표기는 다음 중 하나 이상의 **공적 출처**에서 실제로 쓰이는 표기다:
       · 지자체/기관 공식 페이지  · 한국관광공사  · 시설 간판/안내판
     - 다음이 하나라도 포함되면 **무효**:
       · 감성/추상어: 힐링, 감성, 고요한, 생태, 체험, 테마, 역사문화 등
       · 연결어/조합: ‘및’, ‘그리고’, ‘/’, ‘&’, ‘~’ 등(두 장소 결합/임의 수식)
       · 비공식 변형/별칭/축약형(예: 남산타워 ⇒ 공식: N서울타워)
     - **관할 단어(국립/도립/시립/구립)**는 **공식 표기에 실제로 포함될 때만** 사용한다.
       - 불확실하면 관할 단어를 붙이지 말고, **다른 실존 POI**를 선택한다.
     - **포괄 지명 단독 금지**(산/공원/해변/둘레길/호수/섬/거리/문화지구 등).
       - 반드시 내부의 **구체적 공식 시설명**으로 표기한다(정문·방문자센터·전망대·박물관·선착장 등).
     - **업무/생활 시설 금지**: 주차장, 사옥, 본사, 방송국, MBC, KBS, SBS, 행정복지센터, 구청, 시청, 경찰서, 우체국, 은행, 마트, 영화관, 병원
     **행정조직/사업체/단체명 금지**:
         - “단”, “재단”, “협회”, “추진단”, “위원회”, “본부”, “사업소”, “센터”, “기관”, “연합회”, “사무소”, “연구소”, “문화원”, “협의회”, “전문위원회”, “기획단” 등의 단어를 포함하는 명칭은 관광지로 사용 금지.
         - 예: “청주역사복원추진단”, “문화재단”, “관광협회”, “복원센터”, “시립사업단”, “시청소년수련관” → 모두 무효.
     **공사/복원/개발 중인 명칭 금지**:
         - “복원”, “추진”, “조성”, “건립”, “개발”, “시범”, “예정” 등의 단어가 포함된 명칭은 제외하라.
         - 예: “청주역사복원추진단”, “○○문화조성사업”, “○○복원센터” → 금지.
     - **임의 관할+기관 조합 금지**: <도시명>시립미술관, <도시명>시립박물관, <도시명>도립미술관, <도시명>도립박물관, <도시명>구립미술관, <도시명>구립박물관 (예: "춘천시립미술관" 같은 추정 명칭 금지)
     - 선택된 **시/군/구 경계 내부**의 장소만 허용한다.

    현재 입력된 예산은 %d원이다.
    
- 200,000 ~ 300,000원: **게스트하우스, 모텔만 사용 (전 일정 저가형 숙소)**
- 300,000 ~ 400,000원: **게스트하우스·모텔 1박 + 콘도·펜션 1박 (혼합형 구성)**
- 400,000 ~ 500,000원: **콘도·펜션만 사용 (중간 가격대 숙소)**
- 500,000 ~ 600,000원: **콘도·펜션 1박 + 호텔 1박 (혼합형 구성)**
- 600,000원 이상: **호텔·리조트 모두 사용 가능 (고급형 구성)**

     [숙소 규칙]
     - 형식: "지역(시/군/구) + 업종" 또는 "지역(시/군/구) + (실제 동/읍/면명) + 업종"
       - 예: "제주시 호텔", "서귀포시 리조트", "부산 해운대구 모텔", "제주시 성산읍 펜션"
     - 허용 업종: 호텔, 리조트, 콘도, 펜션, 게스트하우스, 한옥스테이, 모텔
     - 금지: 특정 브랜드/체인명(라마다, 롯데, 신라스테이 등)과 수식/감성어(힐링, 오션뷰, 프리미엄 등)

     [식사 규칙]
     - 형식(정확히): "지역 + 음식종류 + 맛집"
       - 예: "제주시 전복죽 맛집", "대구시 막창 맛집"
     - 음식종류는 **실제 음식점 업종에서 흔히 쓰이는 '단일 음식명'**만 허용.
     - **허용 예시**: 곰탕, 삼겹살, 막창, 회, 초밥, 갈비, 닭갈비, 막국수, 칼국수, 순대, 해장국, 전복죽, 냉면, 갈치조림, 아구찜, 보쌈, 족발, 콩나물국밥, 부대찌개, 찌개, 전골, 우동, 돈까스, 파스타, 피자, 옹심이
     - **금지**:
       - 단일 식재료/농산물/가공식품(옥수수, 감자, 고구마, 토마토, 쌀, 밀, 콩 등)
       - 음료(커피, 차, 주스 등), 디저트(빙수, 케이크, 아이스크림 등), 감성어(현지인 추천, 전통, 브런치 등)
       - 시간대(아침국수, 야식 등), 조합/복합수식(매실갈비, 허브족발, 건강식, 퓨전요리 등)

     [자체 검증 체크리스트]
     - (A) 명칭이 **공적 출처에서 실제 사용되는 정식 표기**인가?
     - (B) 포괄 지명을 단독 사용하지 않았는가? → 내부 **구체적 공식 시설명**으로 표기했는가?
     - (C) 관할 단어(국립/도립/시립/구립)가 **정확히 일치**하는가? 불확실하면 제거하고 다른 실존 POI를 고르라.
     - (D) 업무/생활 시설을 관광지로 넣지 않았는가?
     - (E) 전체 일정에서 **중복 명칭**이 없는가?
     - (F) 선택된 **시/군/구 경계 내부**인가?
     - (G) 모든 날짜가 **정확히 7개 항목**이며 **지정된 순서**를 충족하는가?


[출력 스키마]
{
  "itinerary": [
    {
      "date": "YYYY-MM-DD",
      "travelSchedule": [
        { "type": "식사",   "name": "<지역 음식종류 맛집>"},
        { "type": "관광지", "name": "<공식 POI 명칭>"},
        { "type": "식사",   "name": "<지역 음식종류 맛집>"},
        { "type": "관광지", "name": "<공식 POI 명칭>"},
        { "type": "식사",   "name": "<지역 음식종류 맛집>"},
        { "type": "관광지", "name": "<공식 POI 명칭>"},
        { "type": "숙소",   "name": "<지역(동/읍/면) 업종>"}
      ]
    }
  ]
}

""");

        return sb.toString();
    }
}
